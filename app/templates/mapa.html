{% extends "layout.html" %}
{% block title %}üìç Mapa en tiempo real{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<style>
    #map {
        height: 80vh;
        width: 100%;
        margin-top: 20px;
        border-radius: 12px;
    }

    .custom-marker-img {
        border-radius: 50%;
        border: 2px solid white;
        width: 60px;
        height: 60px;
        object-fit: cover;
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }

    .custom-marker-text {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #4a5568;
        color: white;
        font-weight: bold;
        font-size: 18px;
        border: 2px solid white;
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
</style>
{% endblock %}

{% block content %}
<h1 class="title">üìç Mapa de ubicaciones</h1>
<div id="map"></div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([40.4168, -3.7038], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    fetch("/api/ubicaciones")
        .then(res => res.json())
        .then(posiciones => {
            posiciones.forEach(pos => {
                if (pos.lat && pos.lon) {
                    const hasImage = pos.imagen && pos.imagen !== "" && !pos.imagen.includes("default-avatar");

                    const html = hasImage
                        ? `<img src="${pos.imagen}" class="custom-marker-img" />`
                        : `<div class="custom-marker-text">${pos.user}</div>`;

                    const icon = L.divIcon({
                        className: '',
                        html,
                        iconSize: [60, 60],
                        iconAnchor: [30, 30],
                        popupAnchor: [0, -30]
                    });

                    const marker = L.marker([pos.lat, pos.lon], { icon }).addTo(map);
                    marker.bindPopup(`<strong>${pos.user}</strong><br>${pos.time || ''}`);
                }
            });
        })
        .catch(err => {
            console.error("Error al cargar las ubicaciones:", err);
        });
</script>
{% endblock %}
