{% extends "layout.html" %}
{% block title %}üìç Mapa en tiempo real{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<style>
    #map {
        height: 80vh;
        width: 100%;
        margin-top: 20px;
        border-radius: 12px;
    }

    .custom-marker-text {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #7c3aed; /* fondo violeta */
        color: white;
        font-weight: bold;
        font-size: 22px;
        border: 2px solid white;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<h1 class="title">üìç Mapa de ubicaciones</h1>
<div id="map"></div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([40.4168, -3.7038], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

fetch("/api/ubicaciones")
    .then(res => res.json())
    .then(posiciones => {
        console.log("üì• Ubicaciones recibidas:", posiciones);  // ‚úÖ LOG

        posiciones.forEach(pos => {
            if (pos.lat && pos.lon && pos.user) {
                const initial = pos.user.charAt(0).toUpperCase();

                const icon = L.divIcon({
                    className: '',
                    html: `<div class="custom-marker-text">${initial}</div>`,
                    iconSize: [60, 60],
                    iconAnchor: [30, 30],
                    popupAnchor: [0, -30]
                });

                // Validar y formatear fecha
                let horaFormateada = '';
                if (pos.time) {
                    console.log(`‚è∞ Parsing time for ${pos.user}:`, pos.time);  // ‚úÖ LOG
                    const fecha = new Date(pos.time);
                    if (!isNaN(fecha.getTime())) {
                        horaFormateada = fecha.toLocaleString('es-ES', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                    } else {
                        horaFormateada = 'Hora no disponible';
                        console.warn("‚ö†Ô∏è Fecha inv√°lida:", pos.time);  // ‚úÖ LOG
                    }
                }

                const marker = L.marker([pos.lat, pos.lon], { icon }).addTo(map);
                marker.bindPopup(`<strong>${pos.user}</strong><br>${horaFormateada}`);
            }
        });
    })
    .catch(err => {
        console.error("‚ùå Error al cargar las ubicaciones:", err);
    });

</script>
{% endblock %}
