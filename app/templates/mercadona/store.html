{% extends "layout.html" %}
{% block title %}üõí Mercadona Store - House App{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/mercadona.css') }}">
<style>
    /* Estilos adicionales */
    #categories-section, #products-section {
        transition: all 0.3s ease;
    }
    
    .back-button {
        background: #f3f4f6;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
    }
    
    .back-button:hover {
        background: #e5e7eb;
    }
    
    .search-container {
        position: relative;
        width: 100%;
        max-width: 300px;
    }
    
    .search-container input {
        width: 100%;
        padding: 8px 16px 8px 40px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .search-container i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
    }
    
    .categories-grid, .products-grid {
        opacity: 0;
        transform: translateY(10px);
        animation: fadeInUp 0.5s forwards;
    }
    
    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .search-container {
            max-width: 100%;
            margin-top: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Stats bar -->
<div class="stats-bar">
    <div class="container py-3">
        <div class="flex items-center justify-between text-sm">
            <div class="stats-item">
                <i class="fas fa-warehouse"></i>
                <span>Almac√©n: Madrid (MAD-123)</span>
            </div>
            <div class="stats-item">
                <i class="fas fa-sync-alt"></i>
                <span>√öltima actualizaci√≥n: {{ now.strftime("%Y-%m-%d %H:%M:%S") }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Categories Section - Visible por defecto -->
    <div id="categories-section" class="fade-in">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Categor√≠as de Productos</h2>
            <p class="text-gray-600">Selecciona una categor√≠a para ver sus productos</p>
            
            <!-- B√∫squeda global -->
            <div class="search-container mt-4">
                <input type="text" id="search-products" placeholder="Buscar en todas las categor√≠as...">
                <i class="fas fa-search"></i>
            </div>
        </div>
        
        <div id="categories-grid" class="categories-grid">
            <!-- Categor√≠as se cargan din√°micamente -->
        </div>
    </div>

    <!-- Products Section - Oculto inicialmente -->
    <div id="products-section" class="hidden fade-in">
        <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
            <div>
                <button id="back-to-categories" class="back-button">
                    <i class="fas fa-arrow-left mr-2"></i> Volver a categor√≠as
                </button>
                <h2 id="category-title" class="text-2xl font-bold text-gray-900 mt-4"></h2>
                <p id="products-count" class="text-gray-600"></p>
            </div>
            
            <!-- B√∫squeda en categor√≠a actual -->
            <div class="search-container">
                <input type="text" id="search-in-category" placeholder="Buscar en esta categor√≠a...">
                <i class="fas fa-search"></i>
            </div>
        </div>

        <div id="products-grid" class="products-grid">
            <!-- Los productos se cargan aqu√≠ v√≠a JavaScript -->
        </div>
    </div>
</div>

<!-- Product Modal -->
<div id="product-modal" class="product-modal">
    <div class="modal-content">
        <div class="p-6">
            <!-- Modal content se llena v√≠a JavaScript -->
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div id="toast-container" class="toast-container">
    <!-- Toast messages aparecen aqu√≠ -->
</div>

<script>
    // Variables globales
    let currentCategory = null;
    let allProducts = [];
    let filteredProducts = [];
    let categoriesData = [];

    // Iconos por categor√≠a
    const categoryIcons = {
        'Aceite, especias y salsas': 'ü´í',
        'Agua y refrescos': 'ü•§',
        'Aperitivos': 'ü•®',
        'Arroz, legumbres y pasta': 'üçù',
        'Az√∫car, caramelos y chocolate': 'üç´',
        'Beb√©': 'üë∂',
        'Bodega': 'üç∑',
        'Cacao, caf√© e infusiones': '‚òï',
        'Carnicer√≠a y charcuter√≠a': 'ü•©',
        'Cereales': 'ü•£',
        'Congelados': 'üßä',
        'Conservas': 'ü•´',
        'Droguer√≠a': 'üßΩ',
        'Frutas y verduras': 'ü•ï',
        'Galletas': 'üç™',
        'Higiene y belleza': 'üß¥',
        'L√°cteos y huevos': 'ü•õ',
        'Limpieza': 'üßΩ',
        'Panader√≠a y pasteler√≠a': 'üçû',
        'Pescader√≠a': 'üêü',
        'Platos preparados': 'üçΩÔ∏è',
        'Zumos': 'üßÉ'
    };

    // ========================================
    // FUNCIONES PRINCIPALES
    // ========================================

    async function loadCategories() {
        try {
            showLoading();

            const response = await fetch('/mercadona/categories');
            const data = await response.json();

            if (data.success && data.categories.length > 0) {
                categoriesData = data.categories;
                displayCategories(data.categories);
                hideLoading();
                showCategories();
            } else {
                throw new Error(data.error || 'No se encontraron categor√≠as');
            }
        } catch (error) {
            console.error('Error loading categories:', error);
            showToast(`Error: ${error.message}`, 'error');
            showError();
        }
    }

    async function loadCategoryProducts(categoryId, categoryName) {
        try {
            showLoading();
            
            const response = await fetch(`/mercadona/category/${categoryId}`);
            const data = await response.json();

            if (data.success) {
                currentCategory = {
                    id: categoryId,
                    name: categoryName,
                    isSearch: false
                };
                
                allProducts = data.products;
                filteredProducts = [...allProducts];
                
                // Actualizar UI
                document.getElementById('category-title').textContent = categoryName;
                document.getElementById('products-count').textContent = `${filteredProducts.length} productos`;
                
                // Ocultar categor√≠as y mostrar productos
                hideCategories();
                displayProducts();
                showProducts();
                
                // Limpiar b√∫squeda
                document.getElementById('search-in-category').value = '';
            } else {
                throw new Error(data.error || 'Error al cargar productos');
            }
        } catch (error) {
            console.error('Error loading products:', error);
            showToast('Error al cargar productos', 'error');
        } finally {
            hideLoading();
        }
    }

    function backToCategories() {
        showCategories();
        currentCategory = null;
        allProducts = [];
        filteredProducts = [];
    }

    async function searchAllProducts(query) {
        try {
            showLoading();

            const response = await fetch(`/mercadona/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (data.success) {
                currentCategory = {
                    id: null,
                    name: `Resultados de: "${query}"`,
                    isSearch: true
                };

                allProducts = data.products;
                filteredProducts = [...allProducts];

                // Actualizar UI
                document.getElementById('category-title').textContent = currentCategory.name;
                document.getElementById('products-count').textContent = `${filteredProducts.length} productos encontrados`;
                
                // Ocultar categor√≠as y mostrar productos
                hideCategories();
                displayProducts();
                showProducts();
            } else {
                throw new Error(data.error || 'Error en la b√∫squeda');
            }
        } catch (error) {
            console.error('Error searching products:', error);
            showToast(`Error: ${error.message}`, 'error');
        } finally {
            hideLoading();
        }
    }

    // ========================================
    // FUNCIONES DE VISUALIZACI√ìN
    // ========================================

    function displayCategories(categories) {
        const grid = document.getElementById('categories-grid');
        if (!grid) return;
        
        grid.innerHTML = '';

        categories.forEach((category, index) => {
            const icon = categoryIcons[category.name] || 'üõçÔ∏è';

            const categoryCard = document.createElement('div');
            categoryCard.className = 'category-card slide-in-up';
            categoryCard.style.animationDelay = `${index * 0.1}s`;
            categoryCard.onclick = () => loadCategoryProducts(category.id, category.name);
            
            categoryCard.innerHTML = `
                <div class="text-center">
                    <div class="category-icon">${icon}</div>
                    <h3 class="category-name">${category.name}</h3>
                    <p class="category-subcategories">${category.subcategories_count} subcategor√≠as</p>
                    <div class="category-id-badge">
                        ID: ${category.id}
                    </div>
                </div>
            `;
            
            grid.appendChild(categoryCard);
        });
    }

    function displayProducts() {
        const grid = document.getElementById('products-grid');
        const titleEl = document.getElementById('category-title');
        const countEl = document.getElementById('products-count');

        if (!grid || !titleEl || !countEl) return;

        countEl.textContent = `${filteredProducts.length} productos`;
        grid.innerHTML = '';

        if (filteredProducts.length === 0) {
            grid.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search fa-3x mb-4 text-gray-400"></i>
                    <h3 class="text-xl font-semibold mb-2">No se encontraron productos</h3>
                    <p class="text-gray-600">Intenta con otro t√©rmino de b√∫squeda</p>
                </div>
            `;
            return;
        }

        filteredProducts.forEach((product, index) => {
            const hasDiscount = product.is_discounted || (product.previous_price && product.previous_price.trim() !== '');
            const priceDisplay = hasDiscount ?
                `<span class="price-main price-discount">${product.price}‚Ç¨</span>
                 ${product.previous_price ? `<span class="price-old">${product.previous_price.trim()}‚Ç¨</span>` : ''}` :
                `<span class="price-main price-regular">${product.price}‚Ç¨</span>`;

            const productCard = document.createElement('div');
            productCard.className = 'product-card slide-in-up';
            productCard.style.animationDelay = `${index * 0.1}s`;
            
            productCard.innerHTML = `
                <div class="product-image-container">
                    <img src="${product.thumbnail}" 
                         alt="${product.name}" 
                         class="product-image"
                         onerror="this.src='/static/img/default_food.jpg'">
                    ${hasDiscount ? '<div class="discount-badge">¬°Oferta!</div>' : ''}
                </div>
                
                <div class="product-content">
                    <h3 class="product-name">${product.name}</h3>
                    <p class="product-details">${product.packaging} ‚Ä¢ ${product.size}${product.size_format}</p>
                    
                    <div class="product-price-section">
                        <div>${priceDisplay}</div>
                        <div class="price-reference">${product.reference_price}‚Ç¨/${product.size_format}</div>
                    </div>
                    
                    <div class="product-actions">
                        <div class="quantity-controls">
                            <button onclick="changeQuantity('${product.id}', -1)" class="quantity-btn">
                                <i class="fas fa-minus text-xs"></i>
                            </button>
                            <span id="qty-${product.id}" class="quantity-display">1</span>
                            <button onclick="changeQuantity('${product.id}', 1)" class="quantity-btn">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                        
                        <button onclick="addToList('${product.id}', getQuantity('${product.id}'))" class="add-to-cart-btn">
                            <i class="fas fa-plus"></i>
                            <span>A√±adir</span>
                        </button>
                    </div>
                    
                    <button onclick="showProductDetails('${product.id}')" class="details-btn">
                        Ver detalles
                    </button>
                </div>
            `;
            
            grid.appendChild(productCard);
        });
    }

    // ========================================
    // FUNCIONES DE VISIBILIDAD
    // ========================================

    function showCategories() {
        document.getElementById('categories-section').classList.remove('hidden');
        document.getElementById('products-section').classList.add('hidden');
        document.getElementById('search-products').value = '';
    }

    function hideCategories() {
        document.getElementById('categories-section').classList.add('hidden');
    }

    function showProducts() {
        document.getElementById('categories-section').classList.add('hidden');
        document.getElementById('products-section').classList.remove('hidden');
    }

    function showLoading() {
        // Implementar seg√∫n tu dise√±o
        console.log("Loading...");
    }

    function hideLoading() {
        // Implementar seg√∫n tu dise√±o
        console.log("Loading complete");
    }

    function showError() {
        showToast('Error al cargar la aplicaci√≥n', 'error');
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================

    document.addEventListener('DOMContentLoaded', function() {
        // Cargar categor√≠as al inicio
        loadCategories();

        // Bot√≥n de volver
        document.getElementById('back-to-categories').addEventListener('click', backToCategories);
        
        // B√∫squeda global
        document.getElementById('search-products').addEventListener('input', debounce(function(e) {
            const query = e.target.value.trim();
            if (query.length >= 2) {
                searchAllProducts(query);
            } else if (query.length === 0 && currentCategory && currentCategory.isSearch) {
                backToCategories();
            }
        }, 300));
        
        // B√∫squeda en categor√≠a actual
        document.getElementById('search-in-category').addEventListener('input', debounce(function(e) {
            const searchTerm = e.target.value.toLowerCase();
            filteredProducts = allProducts.filter(product => 
                product.name.toLowerCase().includes(searchTerm)
            );
            document.getElementById('products-count').textContent = `${filteredProducts.length} productos`;
            displayProducts();
        }, 300));
    });

    // Funci√≥n debounce para optimizar b√∫squedas
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // ========================================
    // FUNCIONES AUXILIARES (simplificadas)
    // ========================================

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;

        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function changeQuantity(productId, delta) {
        const qtyEl = document.getElementById(`qty-${productId}`);
        if (!qtyEl) return;
        
        let currentQty = parseInt(qtyEl.textContent);
        currentQty = Math.max(1, currentQty + delta);
        qtyEl.textContent = currentQty;
    }

    function getQuantity(productId) {
        const qtyEl = document.getElementById(`qty-${productId}`);
        return qtyEl ? parseInt(qtyEl.textContent) : 1;
    }

// ========================================
// FUNCIONES DEL MODAL DE PRODUCTO
// ========================================

async function showProductDetails(productId) {
    try {
        showLoading();

        const response = await fetch(`/mercadona/product/${productId}`);
        const data = await response.json();

        if (data.success) {
            const product = data.product;
            const modal = document.getElementById('product-modal');
            const modalContent = modal.querySelector('.p-6');

            // Construir el contenido del modal
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2 class="modal-title">${product.name}</h2>
                    <button onclick="hideProductDetails()" class="modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-grid">
                    <div class="modal-image-section">
                        <img src="${product.thumbnail}" 
                             alt="${product.name}" 
                             class="modal-main-image"
                             onerror="this.src='/static/img/default_food.jpg'">
                        
                        ${product.photos && product.photos.length > 0 ? `
                        <div class="modal-thumbnails">
                            ${product.photos.slice(0, 4).map(photo => `
                                <img src="${photo.regular || photo.thumbnail}" 
                                     class="modal-thumbnail"
                                     onclick="changeModalImage('${photo.regular || photo.thumbnail}')">
                            `).join('')}
                        </div>` : ''}
                    </div>
                    
                    <div class="modal-info-section">
                        <div class="modal-badges">
                            <span class="modal-badge badge-brand">${product.brand || 'Mercadona'}</span>
                            ${product.origin ? `<span class="modal-badge badge-origin">${product.origin}</span>` : ''}
                        </div>
                        
                        <div class="modal-price-section">
                            <div class="modal-price">
                                ${product.price}‚Ç¨
                                <span class="modal-price-unit">/${product.size_format}</span>
                            </div>
                            ${product.previous_price ? `
                            <div class="modal-old-price">
                                Antes: ${product.previous_price}‚Ç¨
                            </div>` : ''}
                        </div>
                        
                        <div class="modal-details-grid">
                            <div class="modal-detail-item">
                                <i class="fas fa-box-open"></i>
                                <span>${product.packaging || 'No especificado'}</span>
                            </div>
                            <div class="modal-detail-item">
                                <i class="fas fa-ruler-combined"></i>
                                <span>${product.size}${product.size_format}</span>
                            </div>
                            ${product.ean ? `
                            <div class="modal-detail-item">
                                <i class="fas fa-barcode"></i>
                                <span>${product.ean}</span>
                            </div>` : ''}
                        </div>
                        
                        ${product.description ? `
                        <div class="modal-description">
                            <h3 class="modal-section-title">
                                <i class="fas fa-align-left"></i> Descripci√≥n
                            </h3>
                            <p>${product.description}</p>
                        </div>` : ''}
                        
                        ${product.ingredients ? `
                        <div class="modal-ingredients">
                            <h3 class="modal-section-title">
                                <i class="fas fa-list"></i> Ingredientes
                            </h3>
                            <p>${product.ingredients}</p>
                        </div>` : ''}
                        
                        ${product.storage ? `
                        <div class="modal-storage">
                            <h3 class="modal-section-title">
                                <i class="fas fa-temperature-low"></i> Conservaci√≥n
                            </h3>
                            <p>${product.storage}</p>
                        </div>` : ''}
                        
                        <div class="modal-actions">
                            <div class="modal-quantity-controls">
                                <button onclick="changeModalQuantity(-1)" class="modal-quantity-btn">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span id="modal-quantity" class="modal-quantity-display">1</span>
                                <button onclick="changeModalQuantity(1)" class="modal-quantity-btn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            
                            <button onclick="addToListFromModal('${productId}')" class="modal-add-btn">
                                <i class="fas fa-cart-plus"></i>
                                <span>A√±adir a lista</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Mostrar el modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            document.addEventListener('keydown', handleModalKeyDown);
        } else {
            throw new Error(data.error || 'Error al obtener detalles del producto');
        }
    } catch (error) {
        console.error('Error showing product details:', error);
        showToast(`Error: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

function hideProductDetails() {
    const modal = document.getElementById('product-modal');
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
        document.removeEventListener('keydown', handleModalKeyDown);
    }
}

function handleModalKeyDown(e) {
    if (e.key === 'Escape') {
        hideProductDetails();
    }
}

function changeModalImage(imageUrl) {
    const mainImage = document.querySelector('.modal-main-image');
    if (mainImage) {
        mainImage.src = imageUrl;
    }
}

function changeModalQuantity(delta) {
    const quantityEl = document.getElementById('modal-quantity');
    if (quantityEl) {
        let current = parseInt(quantityEl.textContent) || 1;
        current = Math.max(1, current + delta);
        quantityEl.textContent = current;
    }
}

function getModalQuantity() {
    const quantityEl = document.getElementById('modal-quantity');
    return quantityEl ? parseInt(quantityEl.textContent) || 1 : 1;
}

// ========================================
// FUNCIONES PARA A√ëADIR A LISTA
// ========================================

function addToList(productId, quantity = 1, productName = '', packaging = '') {
    const product = allProducts.find(p => p.id == productId);
    if (!product) {
        showToast('Producto no encontrado', 'error');
        return;
    }

    const nameToUse = productName || product.name;
    const packagingToUse = packaging || product.packaging || '';
    const price = product.price || '0';
    const size = product.size || '';
    const sizeFormat = product.size_format || '';

    fetch('/api/add_shopping_item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            product_id: productId,
            name: nameToUse,
            quantity: quantity,
            packaging: packagingToUse,
            price: price,
            size: size,
            size_format: sizeFormat,
            source: 'mercadona'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const action = data.action || 'added';
            const message = action === 'added' ? 
                `‚úÖ ${nameToUse} a√±adido a la lista` : 
                `üîÑ ${nameToUse} actualizado (cantidad: ${data.new_quantity})`;
            showToast(message, 'success');
            
            // Opcional: Actualizar la vista si es necesario
            if (action === 'updated') {
                updateProductQuantityInView(productId, data.new_quantity);
            }
        } else {
            showToast(data.error || 'Error al a√±adir producto', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error de conexi√≥n con el servidor', 'error');
    });
}

function addToListFromModal(productId) {
    const quantity = getModalQuantity();
    const product = allProducts.find(p => p.id == productId);

    if (product) {
        addToList(
            productId, 
            quantity, 
            product.name, 
            product.packaging
        );
        hideProductDetails();
    }
}

function updateProductQuantityInView(productId, newQuantity) {
    // Actualiza la cantidad mostrada en la vista si es necesario
    const qtyElement = document.getElementById(`qty-${productId}`);
    if (qtyElement) {
        qtyElement.textContent = newQuantity;
    }
}

// ========================================
// FUNCI√ìN PARA OBTENER TOKEN CSRF
// ========================================

function getCSRFToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.content : '';
}

</script>
{% endblock %}