{% extends "layout.html" %}
{% block title %}üõí Mercadona Store - House App{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/mercadona.css') }}">
<style>
    /* Variables CSS para consistencia */
    :root {
        --primary-color: #00a651;
        --secondary-color: #e8f5e8;
        --text-primary: #2d3748;
        --text-secondary: #718096;
        --border-color: #e2e8f0;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Layout principal */
    .main-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    /* Header de navegaci√≥n */
    .navigation-header {
        background: white;
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        z-index: 100;
        transition: var(--transition);
    }

    .nav-content {
        display: flex;
        align-items: center;
        justify-content: between;
        padding: 1rem 0;
        gap: 1rem;
        flex-wrap: wrap;
    }

    /* Breadcrumb */
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }

    .breadcrumb-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .breadcrumb-separator {
        color: var(--text-secondary);
        margin: 0 0.5rem;
    }

    .breadcrumb-link {
        color: var(--primary-color);
        text-decoration: none;
        cursor: pointer;
        transition: var(--transition);
    }

    .breadcrumb-link:hover {
        text-decoration: underline;
    }

    /* Bot√≥n de volver mejorado */
    .back-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--secondary-color);
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
        padding: 0.75rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: var(--transition);
        cursor: pointer;
    }

    .back-button:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow);
    }

    /* B√∫squeda mejorada */
    .search-section {
        flex: 1;
        max-width: 400px;
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        transition: var(--transition);
        background: white;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 166, 81, 0.1);
    }

    .search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        pointer-events: none;
    }

    .search-clear {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        opacity: 0;
        transition: var(--transition);
    }

    .search-clear.visible {
        opacity: 1;
    }

    .search-clear:hover {
        background: var(--border-color);
        color: var(--text-primary);
    }

    /* Stats bar */
    .stats-bar {
        background: linear-gradient(135deg, var(--primary-color), #008a45);
        color: white;
        padding: 0.75rem 0;
    }

    .stats-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.875rem;
    }

    .stats-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .stats-item i {
        opacity: 0.8;
    }

    /* Secciones principales */
    .main-section {
        padding: 2rem 0;
        transition: var(--transition);
    }

    .section-header {
        margin-bottom: 2rem;
        text-align: center;
    }

    .section-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .section-subtitle {
        color: var(--text-secondary);
        font-size: 1.125rem;
    }

    /* Grid de categor√≠as */
    .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.6s forwards;
    }

    .category-card {
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .category-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(0, 166, 81, 0.1), transparent);
        transition: left 0.5s;
    }

    .category-card:hover::before {
        left: 100%;
    }

    .category-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px -8px rgba(0, 166, 81, 0.3);
        border-color: var(--primary-color);
    }

    .category-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: block;
    }

    .category-name {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .category-subcategories {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: 1rem;
    }

    .category-id-badge {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: var(--secondary-color);
        color: var(--primary-color);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    /* Grid de productos */
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.6s forwards;
    }

    .product-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        transition: var(--transition);
        position: relative;
    }

    .product-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
        border-color: var(--primary-color);
    }

    /* Loading states */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
    }

    .loading-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    /* Animaciones */
    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .slide-in-up {
        animation: slideInUp 0.5s ease-out forwards;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Estados de visibilidad */
    .hidden {
        display: none !important;
    }

    .fade-out {
        opacity: 0;
        transform: translateY(-10px);
        pointer-events: none;
    }

    .fade-in {
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .nav-content {
            flex-direction: column;
            align-items: stretch;
        }

        .search-section {
            max-width: 100%;
        }

        .stats-content {
            flex-direction: column;
            text-align: center;
        }

        .categories-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .products-grid {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .section-title {
            font-size: 1.5rem;
        }
    }

    @media (max-width: 480px) {
        .main-container {
            padding: 0 0.5rem;
        }

        .categories-grid {
            grid-template-columns: 1fr;
        }

        .products-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Mejoras de accesibilidad */
    .category-card:focus,
    .product-card:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
    }

    .back-button:focus,
    .search-input:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
    }

    /* Estados de error y vac√≠o */
    .no-results {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-secondary);
    }

    .no-results i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .error-state {
        text-align: center;
        padding: 3rem 1rem;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        color: #dc2626;
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
</div>

<!-- Stats Bar -->
<div class="stats-bar">
    <div class="main-container">
        <div class="stats-content">
            <div class="stats-item">
                <i class="fas fa-warehouse"></i>
                <span>Almac√©n: Madrid (MAD-123)</span>
            </div>
            <div class="stats-item">
                <i class="fas fa-clock"></i>
                <span id="last-update">{{ now.strftime("%H:%M:%S") }}</span>
            </div>
            <div class="stats-item">
                <i class="fas fa-shopping-list"></i>
                <span id="cart-count">{{ stats.current_list_items }} productos en tu lista</span>
            </div>
        </div>
    </div>
</div>

<!-- Navigation Header -->
<div class="navigation-header">
    <div class="main-container">
        <div class="nav-content">
            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <span class="breadcrumb-item">
                    <i class="fas fa-store"></i>
                    <span class="breadcrumb-link" onclick="showCategories()">Mercadona</span>
                </span>
                <span id="breadcrumb-separator" class="breadcrumb-separator hidden">
                    <i class="fas fa-chevron-right"></i>
                </span>
                <span id="breadcrumb-category" class="breadcrumb-item hidden">
                    <span id="breadcrumb-category-name"></span>
                </span>
            </div>

            <!-- B√∫squeda Universal -->
            <div class="search-section">
                <div style="position: relative;">
                    <i class="fas fa-search search-icon"></i>
                    <input 
                        type="text" 
                        id="universal-search" 
                        class="search-input"
                        placeholder="Buscar productos en Mercadona..."
                        autocomplete="off"
                        aria-label="Buscar productos"
                    >
                    <button id="search-clear" class="search-clear" aria-label="Limpiar b√∫squeda">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Bot√≥n de Volver (solo visible en productos) -->
            <button id="back-to-categories" class="back-button hidden" aria-label="Volver a categor√≠as">
                <i class="fas fa-arrow-left"></i>
                <span>Volver</span>
            </button>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="main-container">
    <!-- Categories Section -->
    <div id="categories-section" class="main-section fade-in">
        <div class="section-header">
            <h1 class="section-title">Categor√≠as de Productos</h1>
            <p class="section-subtitle">Explora nuestro cat√°logo organizado por categor√≠as</p>
        </div>
        
        <div id="categories-grid" class="categories-grid">
            <!-- Las categor√≠as se cargan din√°micamente -->
        </div>
    </div>

    <!-- Products Section -->
    <div id="products-section" class="main-section hidden">
        <div class="section-header">
            <h1 id="products-title" class="section-title"></h1>
            <p id="products-subtitle" class="section-subtitle"></p>
        </div>
        
        <div id="products-grid" class="products-grid">
            <!-- Los productos se cargan din√°micamente -->
        </div>
    </div>
</div>

<!-- Product Modal (simplificado para el ejemplo) -->
<div id="product-modal" class="product-modal hidden">
    <div class="modal-content">
        <div class="p-6">
            <!-- Modal content se llena v√≠a JavaScript -->
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container">
    <!-- Toast messages aparecen aqu√≠ -->
</div>

<script>
// ========================================
// VARIABLES GLOBALES
// ========================================
let currentState = {
    view: 'categories', // 'categories' | 'products'
    category: null,
    products: [],
    filteredProducts: [],
    searchQuery: '',
    isLoading: false
};

let categoriesData = [];

// Iconos por categor√≠a
const categoryIcons = {
    'Aceite, especias y salsas': 'ü´í',
    'Agua y refrescos': 'ü•§',
    'Aperitivos': 'ü•®',
    'Arroz, legumbres y pasta': 'üçù',
    'Az√∫car, caramelos y chocolate': 'üç´',
    'Beb√©': 'üë∂',
    'Bodega': 'üç∑',
    'Cacao, caf√© e infusiones': '‚òï',
    'Carnicer√≠a y charcuter√≠a': 'ü•©',
    'Cereales': 'ü•£',
    'Congelados': 'üßä',
    'Conservas': 'ü•´',
    'Droguer√≠a': 'üßΩ',
    'Frutas y verduras': 'ü•ï',
    'Galletas': 'üç™',
    'Higiene y belleza': 'üß¥',
    'L√°cteos y huevos': 'ü•õ',
    'Limpieza': 'üßΩ',
    'Panader√≠a y pasteler√≠a': 'üçû',
    'Pescader√≠a': 'üêü',
    'Platos preparados': 'üçΩÔ∏è',
    'Zumos': 'üßÉ'
};

// ========================================
// FUNCIONES DE ESTADO Y NAVEGACI√ìN
// ========================================

function updateViewState(newView, data = {}) {
    currentState.view = newView;
    
    // Actualizar UI seg√∫n el estado
    if (newView === 'categories') {
        showCategoriesView();
        updateBreadcrumb();
    } else if (newView === 'products') {
        currentState.category = data.category;
        currentState.products = data.products || [];
        currentState.filteredProducts = [...currentState.products];
        showProductsView();
        updateBreadcrumb(data.category);
    }
    
    // Limpiar b√∫squeda si cambiamos de vista
    if (newView === 'categories') {
        clearSearch();
    }
}

function updateBreadcrumb(category = null) {
    const separator = document.getElementById('breadcrumb-separator');
    const categoryElement = document.getElementById('breadcrumb-category');
    const categoryName = document.getElementById('breadcrumb-category-name');
    
    if (category) {
        separator.classList.remove('hidden');
        categoryElement.classList.remove('hidden');
        categoryName.textContent = category.name;
    } else {
        separator.classList.add('hidden');
        categoryElement.classList.add('hidden');
    }
}

function showCategoriesView() {
    const categoriesSection = document.getElementById('categories-section');
    const productsSection = document.getElementById('products-section');
    const backButton = document.getElementById('back-to-categories');
    
    // Animaci√≥n de salida para productos
    if (!productsSection.classList.contains('hidden')) {
        productsSection.classList.add('fade-out');
        setTimeout(() => {
            productsSection.classList.add('hidden');
            productsSection.classList.remove('fade-out');
        }, 300);
    }
    
    // Mostrar categor√≠as
    setTimeout(() => {
        categoriesSection.classList.remove('hidden');
        categoriesSection.classList.add('fade-in');
    }, 300);
    
    // Ocultar bot√≥n de volver
    backButton.classList.add('hidden');
    
    // Actualizar placeholder de b√∫squeda
    document.getElementById('universal-search').placeholder = 'Buscar productos en Mercadona...';
}

function showProductsView() {
    const categoriesSection = document.getElementById('categories-section');
    const productsSection = document.getElementById('products-section');
    const backButton = document.getElementById('back-to-categories');
    
    // Ocultar categor√≠as con animaci√≥n
    categoriesSection.classList.add('fade-out');
    setTimeout(() => {
        categoriesSection.classList.add('hidden');
        categoriesSection.classList.remove('fade-out');
    }, 300);
    
    // Mostrar productos
    setTimeout(() => {
        productsSection.classList.remove('hidden');
        productsSection.classList.add('fade-in');
        displayProducts();
    }, 300);
    
    // Mostrar bot√≥n de volver
    backButton.classList.remove('hidden');
    
    // Actualizar t√≠tulos
    updateProductsHeader();
    
    // Actualizar placeholder de b√∫squeda
    const placeholder = currentState.category ? 
        `Buscar en ${currentState.category.name}...` : 
        'Buscar productos...';
    document.getElementById('universal-search').placeholder = placeholder;
}

function updateProductsHeader() {
    const title = document.getElementById('products-title');
    const subtitle = document.getElementById('products-subtitle');
    
    if (currentState.category) {
        if (currentState.category.isSearch) {
            title.textContent = `Resultados de b√∫squeda`;
            subtitle.textContent = `${currentState.filteredProducts.length} productos encontrados para "${currentState.searchQuery}"`;
        } else {
            title.textContent = currentState.category.name;
            subtitle.textContent = `${currentState.filteredProducts.length} productos disponibles`;
        }
    }
}

// ========================================
// FUNCIONES DE CARGA DE DATOS
// ========================================

async function loadCategories() {
    if (currentState.isLoading) return;
    
    try {
        setLoading(true);
        
        const response = await fetch('/mercadona/categories');
        const data = await response.json();
        
        if (data.success && data.categories.length > 0) {
            categoriesData = data.categories;
            displayCategories(data.categories);
            updateViewState('categories');
        } else {
            throw new Error(data.error || 'No se encontraron categor√≠as');
        }
    } catch (error) {
        console.error('Error loading categories:', error);
        showToast(`Error: ${error.message}`, 'error');
        showErrorState('categories-grid');
    } finally {
        setLoading(false);
    }
}

async function loadCategoryProducts(categoryId, categoryName) {
    if (currentState.isLoading) return;
    
    try {
        setLoading(true);
        
        const response = await fetch(`/mercadona/category/${categoryId}`);
        const data = await response.json();
        
        if (data.success) {
            const category = {
                id: categoryId,
                name: categoryName,
                isSearch: false
            };
            
            updateViewState('products', {
                category: category,
                products: data.products
            });
        } else {
            throw new Error(data.error || 'Error al cargar productos');
        }
    } catch (error) {
        console.error('Error loading products:', error);
        showToast('Error al cargar productos', 'error');
    } finally {
        setLoading(false);
    }
}

// ========================================
// SISTEMA DE CACH√â FRONTEND
// ========================================

class FrontendSearchCache {
    constructor(maxSize = 50, ttlMinutes = 15) {
        this.maxSize = maxSize;
        this.ttlMs = ttlMinutes * 60 * 1000;
        this.cache = new Map();
        this.accessOrder = [];
    }
    
    _generateKey(query, filters = {}) {
        const keyData = {
            query: query.toLowerCase().trim(),
            filters: filters
        };
        return JSON.stringify(keyData);
    }
    
    _isExpired(timestamp) {
        return (Date.now() - timestamp) > this.ttlMs;
    }
    
    _updateAccessOrder(key) {
        // Mover al final (LRU)
        const index = this.accessOrder.indexOf(key);
        if (index > -1) {
            this.accessOrder.splice(index, 1);
        }
        this.accessOrder.push(key);
    }
    
    get(query, filters = {}) {
        const key = this._generateKey(query, filters);
        const entry = this.cache.get(key);
        
        if (entry) {
            if (!this._isExpired(entry.timestamp)) {
                this._updateAccessOrder(key);
                console.log(`üéØ Frontend Cache HIT para: "${query}"`);
                return {
                    ...entry.data,
                    from_frontend_cache: true,
                    frontend_cache_age_ms: Date.now() - entry.timestamp
                };
            } else {
                // Eliminar entrada expirada
                this.cache.delete(key);
                const orderIndex = this.accessOrder.indexOf(key);
                if (orderIndex > -1) {
                    this.accessOrder.splice(orderIndex, 1);
                }
                console.log(`‚è∞ Frontend Cache EXPIRED para: "${query}"`);
            }
        }
        
        console.log(`üí• Frontend Cache MISS para: "${query}"`);
        return null;
    }
    
    set(query, data, filters = {}) {
        const key = this._generateKey(query, filters);
        
        // Si la cach√© est√° llena, eliminar el menos usado (LRU)
        if (this.cache.size >= this.maxSize) {
            const oldestKey = this.accessOrder.shift();
            this.cache.delete(oldestKey);
            console.log(`üóëÔ∏è Frontend Cache LRU eliminaci√≥n para: ${oldestKey}`);
        }
        
        this.cache.set(key, {
            data: data,
            timestamp: Date.now()
        });
        
        this._updateAccessOrder(key);
        
        console.log(`üíæ Frontend Cache SAVE para: "${query}" (${data.products?.length || 0} productos)`);
    }
    
    clear() {
        this.cache.clear();
        this.accessOrder = [];
        console.log('üßπ Frontend Cache limpiada');
    }
    
    getStats() {
        return {
            totalEntries: this.cache.size,
            maxSize: this.maxSize,
            ttlMinutes: this.ttlMs / (60 * 1000),
            oldestEntry: this.accessOrder.length > 0 ? this.accessOrder[0] : null,
            newestEntry: this.accessOrder.length > 0 ? this.accessOrder[this.accessOrder.length - 1] : null
        };
    }
}

// Instancia global de cach√© frontend
const frontendCache = new FrontendSearchCache(50, 15);

// ========================================
// FUNCIONES DE B√öSQUEDA MEJORADAS CON CACH√â
// ========================================

async function searchProducts(query) {
    if (currentState.isLoading || !query.trim()) return;
    
    try {
        currentState.searchQuery = query.trim();
        
        // 1. Intentar obtener de cach√© frontend primero
        const cachedResult = frontendCache.get(query);
        if (cachedResult) {
            // Usar datos cacheados
            const searchCategory = {
                id: null,
                name: `Resultados para "${query}"`,
                isSearch: true
            };
            
            updateViewState('products', {
                category: searchCategory,
                products: cachedResult.products
            });
            
            // Mostrar indicador de cach√©
            showCacheIndicator(cachedResult);
            showToast(`‚ö° ${cachedResult.products.length} productos (desde cach√©)`, 'success');
            return;
        }
        
        // 2. Si no est√° en cach√©, mostrar loading y buscar
        setLoading(true);
        showSearchingMessage(query);
        
        const response = await fetch(`/mercadona/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.success) {
            const searchCategory = {
                id: null,
                name: `Resultados para "${query}"`,
                isSearch: true
            };
            
            // Actualizar estado con los resultados
            updateViewState('products', {
                category: searchCategory,
                products: data.products
            });
            
            // Guardar en cach√© frontend para futuras b√∫squedas
            frontendCache.set(query, data);
            
            // Mostrar indicadores de performance
            showSearchResults(data);
            
            if (data.products.length === 0) {
                showNoResultsMessage(query);
            } else {
                const cacheType = data.from_cache ? 'servidor' : 'b√∫squeda';
                const duration = data.search_duration_seconds ? `${data.search_duration_seconds}s` : '';
                showToast(`‚úÖ ${data.products.length} productos encontrados (${cacheType}) ${duration}`, 'success');
            }
        } else {
            throw new Error(data.error || 'Error en la b√∫squeda');
        }
    } catch (error) {
        console.error('Error searching products:', error);
        showToast(`‚ùå Error: ${error.message}`, 'error');
        showSearchErrorMessage(query, error.message);
    } finally {
        setLoading(false);
    }
}

function showCacheIndicator(cachedData) {
    // Mostrar indicador visual de que los datos vienen de cach√©
    const searchSection = document.querySelector('.search-section');
    if (searchSection) {
        const indicator = document.createElement('div');
        indicator.className = 'cache-indicator';
        indicator.innerHTML = `
            <i class="fas fa-bolt"></i>
            <span>Desde cach√© (${Math.round(cachedData.frontend_cache_age_ms / 1000)}s)</span>
        `;
        
        searchSection.appendChild(indicator);
        
        // Remover despu√©s de 3 segundos
        setTimeout(() => {
            if (indicator.parentElement) {
                indicator.remove();
            }
        }, 3000);
    }
}

function showSearchResults(data) {
    // Mostrar informaci√≥n detallada de la b√∫squeda
    const searchInfo = {
        total: data.total_found,
        duration: data.search_duration_seconds,
        fromCache: data.from_cache,
        subcategories: data.searched_subcategories
    };
    
    console.log('üìä Resultados de b√∫squeda:', searchInfo);
    
    // Actualizar t√≠tulo con informaci√≥n adicional
    updateProductsHeader(data);
}

function updateProductsHeader(searchData = null) {
    const title = document.getElementById('products-title');
    const subtitle = document.getElementById('products-subtitle');
    
    if (currentState.category) {
        if (currentState.category.isSearch) {
            title.textContent = currentState.category.name;
            
            let subtitleText = `${currentState.filteredProducts.length} productos encontrados`;
            
            if (searchData) {
                if (searchData.from_cache) {
                    subtitleText += ' (desde cach√© del servidor)';
                } else if (searchData.search_duration_seconds) {
                    subtitleText += ` en ${searchData.search_duration_seconds}s`;
                }
                
                if (searchData.searched_subcategories) {
                    subtitleText += ` ‚Ä¢ ${searchData.searched_subcategories} categor√≠as exploradas`;
                }
            }
            
            subtitle.textContent = subtitleText;
        } else {
            title.textContent = currentState.category.name;
            subtitle.textContent = `${currentState.filteredProducts.length} productos disponibles`;
        }
    }
}

// ========================================
// GESTI√ìN DE CACH√â
// ========================================

function clearAllCaches() {
    frontendCache.clear();
    showToast('üßπ Cach√© limpiada', 'info');
}

function getCacheStats() {
    const stats = frontendCache.getStats();
    console.log('üìä Estad√≠sticas de cach√© frontend:', stats);
    return stats;
}

// ========================================
// FUNCIONES DE DEBUG Y MONITORING
// ========================================

function debugSearchCache() {
    console.log('=== DEBUG: Search Cache ===');
    console.log('Frontend Cache Stats:', frontendCache.getStats());
    
    // Obtener stats del backend tambi√©n
    fetch('/api/mercadona/cache/stats')
        .then(response => response.json())
        .then(data => {
            console.log('Backend Cache Stats:', data);
        })
        .catch(error => {
            console.log('Error obteniendo stats del backend:', error);
        });
}

// Exponer funciones para debug en consola
window.debugMercadona = {
    clearCache: clearAllCaches,
    getStats: getCacheStats,
    debugCache: debugSearchCache,
    frontendCache: frontendCache
};

function showSearchingMessage(query) {
    // Si ya estamos en vista de productos, mostrar mensaje temporal
    if (currentState.view === 'products') {
        const grid = document.getElementById('products-grid');
        if (grid) {
            grid.innerHTML = `
                <div class="searching-message">
                    <i class="fas fa-search fa-2x text-primary mb-3"></i>
                    <h3>Buscando "${query}"...</h3>
                    <p class="text-secondary">Explorando todas las categor√≠as de Mercadona</p>
                    <div class="loading-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
        }
    }
}

function showNoResultsMessage(query) {
    const grid = document.getElementById('products-grid');
    if (!grid) return;
    
    grid.innerHTML = `
        <div class="no-results">
            <i class="fas fa-search fa-3x mb-4 text-gray-400"></i>
            <h3 class="text-xl font-semibold mb-2">No se encontraron productos</h3>
            <p class="text-gray-600 mb-4">No hay productos que coincidan con "${query}"</p>
            <div class="suggestions">
                <h4 class="font-semibold mb-2">Sugerencias:</h4>
                <ul class="text-left text-gray-600">
                    <li>‚Ä¢ Verifica la ortograf√≠a de tu b√∫squeda</li>
                    <li>‚Ä¢ Intenta con t√©rminos m√°s generales</li>
                    <li>‚Ä¢ Usa sin√≥nimos o nombres alternativos</li>
                    <li>‚Ä¢ Busca por marca en lugar del producto espec√≠fico</li>
                </ul>
            </div>
            <button onclick="clearSearch()" class="back-button mt-4">
                <i class="fas fa-arrow-left"></i>
                Volver a categor√≠as
            </button>
        </div>
    `;
}

function showSearchErrorMessage(query, errorMessage) {
    const grid = document.getElementById('products-grid');
    if (!grid) return;
    
    grid.innerHTML = `
        <div class="error-state">
            <i class="fas fa-exclamation-triangle fa-3x mb-4"></i>
            <h3 class="text-xl font-semibold mb-2">Error en la b√∫squeda</h3>
            <p class="mb-2">No se pudo buscar "${query}"</p>
            <p class="text-sm text-gray-600 mb-4">Error: ${errorMessage}</p>
            <div class="flex gap-3 justify-center">
                <button onclick="searchProducts('${query}')" class="back-button">
                    <i class="fas fa-refresh"></i>
                    Reintentar
                </button>
                <button onclick="clearSearch()" class="back-button">
                    <i class="fas fa-arrow-left"></i>
                    Volver a categor√≠as
                </button>
            </div>
        </div>
    `;
}

// ========================================
// FUNCIONES DE VISUALIZACI√ìN
// ========================================

function displayCategories(categories) {
    const grid = document.getElementById('categories-grid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    categories.forEach((category, index) => {
        const icon = categoryIcons[category.name] || 'üõçÔ∏è';
        
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card slide-in-up';
        categoryCard.style.animationDelay = `${index * 0.1}s`;
        categoryCard.setAttribute('tabindex', '0');
        categoryCard.setAttribute('role', 'button');
        categoryCard.setAttribute('aria-label', `Ver productos de ${category.name}`);
        
        categoryCard.innerHTML = `
            <div class="category-icon">${icon}</div>
            <h3 class="category-name">${category.name}</h3>
            <p class="category-subcategories">${category.subcategories_count} subcategor√≠as</p>
            <div class="category-id-badge">ID: ${category.id + 100}</div>
        `;
        
        // Event listeners
        categoryCard.addEventListener('click', () => loadCategoryProducts(category.id, category.name));
        categoryCard.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                loadCategoryProducts(category.id, category.name);
            }
        });
        
        grid.appendChild(categoryCard);
    });
}

function displayProducts() {
    const grid = document.getElementById('products-grid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    if (currentState.filteredProducts.length === 0) {
        grid.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h3>No se encontraron productos</h3>
                <p>Intenta con otros t√©rminos de b√∫squeda o explora las categor√≠as</p>
            </div>
        `;
        return;
    }
    
    currentState.filteredProducts.forEach((product, index) => {
        const productCard = createProductCard(product, index);
        grid.appendChild(productCard);
    });
    
    updateProductsHeader();
}

function createProductCard(product, index) {
    const hasDiscount = product.is_discounted || (product.previous_price && product.previous_price.trim() !== '');
    
    const productCard = document.createElement('div');
    productCard.className = 'product-card slide-in-up';
    productCard.style.animationDelay = `${index * 0.05}s`;
    
    productCard.innerHTML = `
        <div class="product-image-container">
            <img src="${product.thumbnail}" 
                 alt="${product.name}" 
                 class="product-image"
                 loading="lazy"
                 onerror="this.src='/static/img/default_food.jpg'">
            ${hasDiscount ? '<div class="discount-badge">¬°Oferta!</div>' : ''}
        </div>
        
        <div class="product-content">
            <h3 class="product-name">${product.name}</h3>
            <p class="product-details">${product.packaging} ‚Ä¢ ${product.size}${product.size_format}</p>
            
            <div class="product-price-section">
                <div class="product-price">
                    ${hasDiscount ? 
                        `<span class="price-main price-discount">${product.price}‚Ç¨</span>
                         ${product.previous_price ? `<span class="price-old">${product.previous_price.trim()}‚Ç¨</span>` : ''}` :
                        `<span class="price-main price-regular">${product.price}‚Ç¨</span>`
                    }
                </div>
                <div class="price-reference">${product.reference_price}‚Ç¨/${product.size_format}</div>
            </div>
            
            <div class="product-actions">
                <div class="quantity-controls">
                    <button onclick="changeQuantity('${product.id}', -1)" class="quantity-btn" aria-label="Disminuir cantidad">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span id="qty-${product.id}" class="quantity-display">1</span>
                    <button onclick="changeQuantity('${product.id}', 1)" class="quantity-btn" aria-label="Aumentar cantidad">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <button onclick="addToList('${product.id}')" class="add-to-cart-btn" aria-label="A√±adir ${product.name} a la lista">
                    <i class="fas fa-plus"></i>
                    <span>A√±adir</span>
                </button>
            </div>
            
            <button onclick="showProductDetails('${product.id}')" class="details-btn">
                Ver detalles
            </button>
        </div>
    `;
    
    return productCard;
}

// ========================================
// FUNCIONES DE UTILIDAD
// ========================================

function setLoading(isLoading) {
    currentState.isLoading = isLoading;
    const overlay = document.getElementById('loading-overlay');
    
    if (isLoading) {
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    } else {
        overlay.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
}

function showErrorState(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = `
        <div class="error-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error al cargar contenido</h3>
            <p>No se pudieron cargar los datos. Por favor, intenta de nuevo.</p>
            <button onclick="location.reload()" class="back-button" style="margin-top: 1rem;">
                <i class="fas fa-refresh"></i>
                Reintentar
            </button>
        </div>
    `;
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    const iconMap = {
        success: 'check-circle',
        error: 'exclamation-circle',
        warning: 'exclamation-triangle',
        info: 'info-circle'
    };
    
    toast.innerHTML = `
        <i class="fas fa-${iconMap[type] || iconMap.info}"></i>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="toast-close">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(toast);
    
    // Animaci√≥n de entrada
    setTimeout(() => toast.classList.add('show'), 100);
    
    // Auto-remove despu√©s de 5 segundos
    setTimeout(() => {
        if (toast.parentElement) {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

function clearSearch() {
    const searchInput = document.getElementById('universal-search');
    const clearButton = document.getElementById('search-clear');
    
    searchInput.value = '';
    clearButton.classList.remove('visible');
    currentState.searchQuery = '';
    
    // Si estamos en vista de productos y era una b√∫squeda, volver a categor√≠as
    if (currentState.view === 'products' && currentState.category && currentState.category.isSearch) {
        showCategories();
    }
}

function filterProductsInCurrentCategory(query) {
    if (!query.trim()) {
        currentState.filteredProducts = [...currentState.products];
    } else {
        const searchTerm = query.toLowerCase();
        currentState.filteredProducts = currentState.products.filter(product => 
            product.name.toLowerCase().includes(searchTerm) ||
            product.packaging.toLowerCase().includes(searchTerm)
        );
    }
    
    if (currentState.view === 'products') {
        displayProducts();
    }
}

// ========================================
// FUNCIONES DE NAVEGACI√ìN
// ========================================

function showCategories() {
    updateViewState('categories');
}

function backToCategories() {
    showCategories();
}

// ========================================
// FUNCIONES DE PRODUCTOS
// ========================================

function changeQuantity(productId, delta) {
    const qtyEl = document.getElementById(`qty-${productId}`);
    if (!qtyEl) return;
    
    let currentQty = parseInt(qtyEl.textContent) || 1;
    currentQty = Math.max(1, Math.min(99, currentQty + delta));
    qtyEl.textContent = currentQty;
}

function getQuantity(productId) {
    const qtyEl = document.getElementById(`qty-${productId}`);
    return qtyEl ? parseInt(qtyEl.textContent) || 1 : 1;
}

function addToList(productId) {
    const product = currentState.products.find(p => p.id == productId) || 
                   currentState.filteredProducts.find(p => p.id == productId);
    
    if (!product) {
        showToast('Producto no encontrado', 'error');
        return;
    }
    
    const quantity = getQuantity(productId);
    
    // Mostrar loading en el bot√≥n
    const addButton = document.querySelector(`button[onclick="addToList('${productId}')"]`);
    const originalContent = addButton.innerHTML;
    addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>A√±adiendo...</span>';
    addButton.disabled = true;
    
    fetch('/api/add_shopping_item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            product_id: productId,
            name: product.name,
            quantity: quantity,
            packaging: product.packaging || '',
            price: product.price || '0',
            size: product.size || '',
            size_format: product.size_format || '',
            source: 'mercadona'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const action = data.action || 'added';
            const message = action === 'added' ? 
                `‚úÖ ${product.name} a√±adido a la lista` : 
                `üîÑ ${product.name} actualizado (cantidad: ${data.new_quantity})`;
            
            showToast(message, 'success');
            
            // Actualizar contador en stats bar
            updateCartCount();
            
            // Resetear cantidad a 1
            const qtyEl = document.getElementById(`qty-${productId}`);
            if (qtyEl) qtyEl.textContent = '1';
            
        } else {
            showToast(data.error || 'Error al a√±adir producto', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error de conexi√≥n con el servidor', 'error');
    })
    .finally(() => {
        // Restaurar bot√≥n
        addButton.innerHTML = originalContent;
        addButton.disabled = false;
    });
}

function updateCartCount() {
    // Esta funci√≥n se puede implementar para actualizar el contador en tiempo real
    // Por ahora, simplemente incrementamos el n√∫mero mostrado
    const cartCountEl = document.getElementById('cart-count');
    if (cartCountEl) {
        const currentText = cartCountEl.textContent;
        const currentNumber = parseInt(currentText.match(/\d+/)) || 0;
        cartCountEl.textContent = `${currentNumber + 1} productos en tu lista`;
    }
}

function showProductDetails(productId) {
    // Esta funci√≥n se puede expandir para mostrar el modal completo
    console.log('Showing details for product:', productId);
    showToast('Funci√≥n de detalles en desarrollo', 'info');
}

function getCSRFToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.content : '';
}

// ========================================
// EVENT LISTENERS
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    // Cargar categor√≠as al inicio
    loadCategories();
    
    // B√∫squeda universal con debounce
    const searchInput = document.getElementById('universal-search');
    const clearButton = document.getElementById('search-clear');
    let searchTimeout;
    
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        // Mostrar/ocultar bot√≥n de limpiar
        if (query.length > 0) {
            clearButton.classList.add('visible');
        } else {
            clearButton.classList.remove('visible');
        }
        
        // Limpiar timeout anterior
        clearTimeout(searchTimeout);
        
        // Decidir qu√© tipo de b√∫squeda hacer
        searchTimeout = setTimeout(() => {
            if (query.length >= 2) {
                // B√∫squeda global si estamos en categor√≠as o si la query es nueva
                if (currentState.view === 'categories' || 
                    (currentState.category && currentState.category.isSearch)) {
                    searchProducts(query);
                } else if (currentState.view === 'products') {
                    // Filtrar en categor√≠a actual
                    filterProductsInCurrentCategory(query);
                }
            } else if (query.length === 0) {
                // Limpiar b√∫squeda
                if (currentState.view === 'products' && currentState.category && currentState.category.isSearch) {
                    showCategories();
                } else if (currentState.view === 'products') {
                    // Mostrar todos los productos de la categor√≠a actual
                    currentState.filteredProducts = [...currentState.products];
                    displayProducts();
                }
            }
        }, 300);
    });
    
    // Bot√≥n de limpiar b√∫squeda
    clearButton.addEventListener('click', clearSearch);
    
    // Bot√≥n de volver a categor√≠as
    document.getElementById('back-to-categories').addEventListener('click', backToCategories);
    
    // Breadcrumb navigation
    document.querySelector('.breadcrumb-link').addEventListener('click', showCategories);
    
    // Atajos de teclado
    document.addEventListener('keydown', function(e) {
        // ESC para volver atr√°s
        if (e.key === 'Escape') {
            if (currentState.view === 'products') {
                backToCategories();
            }
        }
        
        // Ctrl/Cmd + K para enfocar b√∫squeda
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            searchInput.focus();
        }
    });
    
    // Actualizar tiempo cada minuto
    setInterval(() => {
        const now = new Date();
        document.getElementById('last-update').textContent = now.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }, 60000);
});

// ========================================
// UTILIDADES ADICIONALES
// ========================================

// Debounce function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Funci√≥n para manejar errores de im√°genes
function handleImageError(img) {
    img.src = '/static/img/default_food.jpg';
    img.onerror = null; // Prevenir bucle infinito
}

// Funci√≥n para lazy loading manual si es necesario
function lazyLoadImages() {
    const images = document.querySelectorAll('img[data-src]');
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                imageObserver.unobserve(img);
            }
        });
    });
    
    images.forEach(img => imageObserver.observe(img));
}

// Funci√≥n para scroll suave a la parte superior
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// Funci√≥n para detectar si el usuario est√° en m√≥vil
function isMobile() {
    return window.innerWidth <= 768;
}

// Optimizaci√≥n de rendimiento: throttle para scroll
function throttle(func, limit) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    }
}

// Funci√≥n para analytics (si se necesita)
function trackEvent(eventName, properties = {}) {
    console.log('Event:', eventName, properties);
    // Aqu√≠ se puede integrar con Google Analytics, etc.
}

console.log('üõí Mercadona Store initialized');
</script>
{% endblock %}