{% extends "layout.html" %}
{% block title %}Calendario{% endblock %}

{% block extra_css %}
<!-- ... (estilos anteriores se mantienen igual) ... -->
{% endblock %}

{% block content %}
<!-- ... (contenido HTML anterior se mantiene igual) ... -->
{% endblock %}

{% block extra_js %}
<script>
    // ... (c√≥digo anterior se mantiene igual hasta la funci√≥n de env√≠o) ...

    // Enviar formulario unificado - VERSI√ìN CORREGIDA
    document.getElementById('itemForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = document.getElementById('saveBtn');
        const originalText = submitBtn.innerHTML;
        const originalBackground = submitBtn.style.background;
        
        // Mostrar loading
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        submitBtn.disabled = true;

        try {
            let res, result;
            
            if (currentType === "task") {
                // CORRECCI√ìN: Usar los nombres de campo que espera el backend
                const taskData = {
                    titulo: document.getElementById('titulo').value.trim(),
                    asignee: document.getElementById('asignee').value,
                    due_date: document.getElementById('due_date').value,
                    prioridad: document.getElementById('prioridad').value,
                    pasos: document.getElementById('descripcion').value.trim()  // Cambiado a 'pasos'
                };
                
                res = await fetch('/api/add_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData),
                });
                
                if (!res.ok) {
                    throw new Error('Error al a√±adir tarea');
                }
                
                result = await res.json();
                
                // A√±adir evento al calendario
                const newEvent = {
                    id: result.task_id,
                    title: taskData.titulo,
                    start: taskData.due_date,
                    backgroundColor: getPriorityColor(taskData.prioridad),
                    borderColor: getPriorityColor(taskData.prioridad),
                    extendedProps: {
                        asignee: taskData.asignee,
                        prioridad: taskData.prioridad,
                        pasos: taskData.pasos
                    }
                };
                
                calendar.addEvent(newEvent);
                
                // Mostrar √©xito
                submitBtn.innerHTML = '<i class="fas fa-check"></i> ¬°Tarea guardada!';
                submitBtn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                
                setTimeout(() => {
                    closeModal();
                    showNotification('¬°Tarea a√±adida al calendario! üìÖ', 'success');
                }, 800);
                
            } else {
                // CORRECCI√ìN: Usar los nombres de campo que espera el backend
                const eventData = {
                    title: document.getElementById('titulo').value.trim(),  // Cambiado a 'title'
                    start_date: document.getElementById('eventStart').value,
                    end_date: document.getElementById('eventEnd').value || document.getElementById('eventStart').value,
                    description: document.getElementById('descripcion').value.trim(),  // Cambiado a 'description'
                    color: document.getElementById('eventColor').value
                };
                
                res = await fetch('/api/add_event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData),
                });
                
                if (!res.ok) {
                    throw new Error('Error al a√±adir evento');
                }
                
                result = await res.json();
                
                // A√±adir evento al calendario
                const newEvent = {
                    id: result.event_id,
                    title: `‚≠ê ${eventData.title}`,
                    start: eventData.start_date,
                    end: eventData.end_date,
                    allDay: true,
                    backgroundColor: eventData.color,
                    borderColor: eventData.color,
                    extendedProps: {
                        type: "event",
                        reported_by: "{{ session.get('user') }}",
                        description: eventData.description
                    }
                };
                
                calendar.addEvent(newEvent);
                
                // Mostrar √©xito
                submitBtn.innerHTML = '<i class="fas fa-check"></i> ¬°Evento guardado!';
                submitBtn.style.background = 'linear-gradient(135deg, #9c27b0, #7b1fa2)';
                
                setTimeout(() => {
                    closeModal();
                    showNotification('¬°Evento a√±adido al calendario! üåü', 'success');
                }, 800);
            }

        } catch (error) {
            console.error("Error:", error);
            
            // Mostrar error
            submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
            submitBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.style.background = originalBackground;
                submitBtn.disabled = false;
            }, 2000);
        }
    });

    // ... (resto del c√≥digo se mantiene igual) ...
</script>
{% endblock %}