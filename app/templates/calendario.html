{% extends "layout.html" %}
{% block title %}Calendario{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='styles/calendario.css') }}">
{% endblock %}

{% block content %}
<h1 class="title">ðŸ“… Calendario de tareas</h1>
<div id="calendar"></div>

<button id="addTaskBtn" class="floating-btn btn-calendario" title="AÃ±adir tarea">âž•</button>

<div id="overlay" class="overlay">
    <div class="overlay-content">
        <h2>AÃ±adir nueva tarea</h2>
        <form id="taskForm">
            <label for="titulo">TÃ­tulo:</label>
            <input type="text" id="titulo" name="titulo" required>

            <label for="asignee">Asignado a:</label>
            <select id="asignee" name="asignee" required>
                <option value="">Seleccionar usuario</option>
                {% for user in users %}
                <option value="{{ user['nombre'] }}">{{ user['nombre'] }}</option>
                {% endfor %}
            </select>

            <label for="due_date">Fecha lÃ­mite:</label>
            <input type="date" id="due_date" name="due_date" required>

            <label for="pasos">Pasos (opcional):</label>
            <textarea id="pasos" name="pasos" rows="3"></textarea>

            <div class="form-buttons">
                <button type="submit">Guardar</button>
                <button type="button" id="cancelBtn">Cancelar</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: {{ events | tojson }},
        eventColor: '#10b981',
        eventTextColor: '#fff'
    });
    calendar.render();
});

document.getElementById('addTaskBtn').addEventListener('click', () => {
    document.getElementById('overlay').style.display = 'flex';
});
document.getElementById('cancelBtn').addEventListener('click', () => {
    document.getElementById('overlay').style.display = 'none';
});
document.getElementById('taskForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const data = {
        titulo: document.getElementById('titulo').value,
        asignee: document.getElementById('asignee').value,
        due_date: document.getElementById('due_date').value,
        pasos: document.getElementById('pasos').value,
    };

    try {
        const res = await fetch('/api/add_task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });

        if (!res.ok) {
            console.error("Error al aÃ±adir tarea");
            return;
        }

        document.getElementById('overlay').style.display = 'none';
        document.getElementById('taskForm').reset();
        window.location.reload();
    } catch (error) {
        console.error("Error:", error);
    }
});
</script>
{% endblock %}
