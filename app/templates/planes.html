{% extends "layout.html" %}
{% block title %}Planes{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/planes.css') }}">
{% endblock %}

{% block content %}
<h1 class="title">üìã Planes </h1>

<div class="planes-container">
    <div class="planes-list" id="planesList">
        <!-- Los planes se cargar√°n din√°micamente aqu√≠ -->
    </div>
</div>

<button id="addPlanBtn" class="floating-btn btn-planes" title="A√±adir nuevo plan">
    <i class="fas fa-plus"></i>
</button>

<!-- Overlay para a√±adir nuevo plan -->
<div id="overlayPlan" class="overlay">
    <div class="overlay-content">
        <h2><i class="fas fa-plus-circle"></i> Nuevo Plan</h2>
        <form id="planForm">
            <div class="form-group">
                <label for="planTitulo">
                    <i class="fas fa-heading"></i> T√≠tulo:
                </label>
                <input type="text" id="planTitulo" name="titulo" required placeholder="Ej: Renovar el ba√±o">
            </div>

            <div class="form-group">
                <label for="planDescripcion">
                    <i class="fas fa-align-left"></i> Descripci√≥n:
                </label>
                <textarea id="planDescripcion" name="descripcion" rows="3"
                    placeholder="Detalles del plan..."></textarea>
            </div>

            <div class="form-group">
                <label for="planPrioridad">
                    <i class="fas fa-flag"></i> Prioridad:
                </label>
                <select id="planPrioridad" name="prioridad" required>
                    <option value="3">üü¢ Baja</option>
                    <option value="2" selected>üü° Media</option>
                    <option value="1">üî¥ Alta</option>
                </select>
            </div>

            <div class="form-buttons">
                <button type="submit">
                    <i class="fas fa-save"></i> Guardar
                </button>
                <button type="button" id="cancelPlanBtn">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Toast de notificaciones -->
<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div>

{% endblock %}

{% block extra_js %}
<script>
    // ===== VARIABLES GLOBALES =====
    let planes = [];
    
    // Variables para drag & drop tradicional (escritorio)
    let draggedElement = null;
    let draggedId = null;
    
    // Variables para drag & drop t√°ctil (m√≥vil)
    let touchStartY = 0;
    let touchCurrentY = 0;
    let touchOffset = { x: 0, y: 0 };
    let dragPreview = null;
    let isDragging = false;
    let dropTargets = [];

    // ===== DETECCI√ìN DE DISPOSITIVO =====
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
               ('ontouchstart' in window) || 
               (navigator.maxTouchPoints > 0);
    }

    // ===== INICIALIZACI√ìN =====
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('üöÄ Inicializando planes...');
        console.log('üì± Dispositivo m√≥vil:', isMobileDevice());
        
        // A√±adir estilos espec√≠ficos para m√≥vil
        if (isMobileDevice()) {
            addMobileStyles();
        }
        
        await loadPlanes();
        setupEventListeners();
    });

    // ===== ESTILOS DIN√ÅMICOS PARA M√ìVIL =====
    function addMobileStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .plan-card.touch-dragging {
                opacity: 0.3 !important;
                transform: scale(0.95);
                transition: transform 0.2s ease;
            }

            .plan-card.dragging {
                cursor: grabbing;
                z-index: 1000;
            }

            .drag-preview {
                background: var(--plan-bg, #fff);
                border-radius: 12px;
                box-shadow: 0 15px 35px rgba(0,0,0,0.3) !important;
                border: 2px solid #3b82f6 !important;
            }

            .plan-card.drop-target {
                transform: translateY(-3px);
                box-shadow: 0 12px 30px rgba(59, 130, 246, 0.4) !important;
                border: 2px solid #3b82f6;
                background: rgba(59, 130, 246, 0.05);
                transition: all 0.2s ease;
            }

            .plan-card.drop-before::before {
                content: '';
                position: absolute;
                top: -6px;
                left: 10px;
                right: 10px;
                height: 4px;
                background: linear-gradient(90deg, #3b82f6, #1d4ed8);
                border-radius: 2px;
                z-index: 1000;
                box-shadow: 0 2px 4px rgba(59, 130, 246, 0.5);
            }

            .plan-card.drop-after::after {
                content: '';
                position: absolute;
                bottom: -6px;
                left: 10px;
                right: 10px;
                height: 4px;
                background: linear-gradient(90deg, #3b82f6, #1d4ed8);
                border-radius: 2px;
                z-index: 1000;
                box-shadow: 0 2px 4px rgba(59, 130, 246, 0.5);
            }

            .plan-card.drop-success {
                animation: dropSuccess 0.8s ease-out;
            }

            @keyframes dropSuccess {
                0% { 
                    transform: scale(1); 
                    background-color: transparent;
                }
                30% { 
                    transform: scale(1.02); 
                    background-color: rgba(16, 185, 129, 0.1);
                    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                }
                100% { 
                    transform: scale(1); 
                    background-color: transparent;
                }
            }

            .plan-card {
                padding-right: 60px;
            }
            
            .plan-card::after {
                content: '‚ãÆ‚ãÆ';
                position: absolute;
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
                color: #9ca3af;
                font-size: 20px;
                line-height: 1;
                letter-spacing: -3px;
                opacity: 0.6;
                pointer-events: none;
            }
        `;
        document.head.appendChild(style);
    }

    // ===== EVENT LISTENERS =====
    function setupEventListeners() {
        // Bot√≥n a√±adir plan
        document.getElementById('addPlanBtn').addEventListener('click', openPlanModal);
        
        // Bot√≥n cancelar modal
        document.getElementById('cancelPlanBtn').addEventListener('click', closePlanModal);
        
        // Formulario de nuevo plan
        document.getElementById('planForm').addEventListener('submit', handlePlanSubmit);
        
        // Cerrar modal con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePlanModal();
            }
        });
        
        // Click fuera del modal para cerrar
        document.getElementById('overlayPlan').addEventListener('click', (e) => {
            if (e.target.id === 'overlayPlan') {
                closePlanModal();
            }
        });
    }

    // ===== CARGAR PLANES =====
    async function loadPlanes() {
        try {
            console.log('üì• Cargando planes...');
            const response = await fetch('/api/planes');
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            planes = await response.json();
            console.log(`‚úÖ ${planes.length} planes cargados`);
            renderPlanes();
        } catch (error) {
            console.error('‚ùå Error cargando planes:', error);
            showToast('‚ö†Ô∏è Error al cargar planes: ' + error.message, 'error');
            
            // Mostrar mensaje de error en el contenedor
            const container = document.getElementById('planesList');
            container.innerHTML = `
                <div class="error-message" style="text-align: center; padding: 40px; color: #ef4444;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                    Error al cargar los planes
                    <br><small>${error.message}</small>
                    <br><button onclick="loadPlanes()" style="margin-top: 10px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-refresh"></i> Reintentar
                    </button>
                </div>
            `;
        }
    }

    // ===== RENDERIZAR PLANES =====
    function renderPlanes() {
        const container = document.getElementById('planesList');
        container.innerHTML = '';

        if (planes.length === 0) {
            container.innerHTML = `
                <div class="no-plans">
                    <i class="fas fa-clipboard-list"></i>
                    <em>¬°No hay planes creados!</em>
                    <br><small>Haz clic en el bot√≥n + para crear tu primer plan</small>
                </div>
            `;
            return;
        }

        planes.forEach((plan, index) => {
            const planElement = document.createElement('div');
            planElement.className = `plan-card priority-${plan.prioridad}`;
            planElement.dataset.id = plan._id || plan.id;
            planElement.dataset.order = index;
            
            // Solo hacer draggable en escritorio
            if (!isMobileDevice()) {
                planElement.draggable = true;
            }
            
            planElement.innerHTML = `
                <div class="plan-content">
                    <h3>${escapeHtml(plan.titulo)}</h3>
                    ${plan.descripcion ? `<p>${escapeHtml(plan.descripcion)}</p>` : ''}
                    <div class="plan-meta">
                        <span class="plan-date">
                            <i class="fas fa-calendar"></i> ${formatDate(plan.fecha_creacion || plan.created_at)}
                        </span>
                        <span class="plan-priority">
                            ${getPriorityIcon(plan.prioridad)} ${getPriorityText(plan.prioridad)}
                        </span>
                    </div>
                </div>
                <div class="plan-actions">
                    <button class="plan-delete" onclick="deletePlan('${plan._id || plan.id}')" title="Eliminar plan">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="plan-top" onclick="movePlanToTop('${plan._id || plan.id}')" title="Mover al inicio">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(planElement);
        });

        // Configurar drag and drop despu√©s de renderizar
        setupDragAndDrop();
    }

    // ===== CONFIGURAR DRAG AND DROP =====
    function setupDragAndDrop() {
        const container = document.getElementById('planesList');
        const cards = container.querySelectorAll('.plan-card');

        cards.forEach(card => {
            if (isMobileDevice()) {
                // Eventos t√°ctiles para m√≥viles
                setupTouchEvents(card);
            } else {
                // Eventos de mouse para escritorio
                setupMouseEvents(card);
            }
        });

        // Tambi√©n permitir drop en el contenedor para escritorio
        if (!isMobileDevice()) {
            container.addEventListener('dragover', handleDragOver);
            container.addEventListener('drop', handleDropMouse);
        }
    }

    // ===== EVENTOS T√ÅCTILES PARA M√ìVILES =====
    function setupTouchEvents(card) {
        let longPressTimer;
        let hasMoved = false;
        let startPos = { x: 0, y: 0 };

        // Touch start - iniciar posible drag
        card.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            startPos = { x: touch.clientX, y: touch.clientY };
            hasMoved = false;

            // Long press para iniciar drag (600ms)
            longPressTimer = setTimeout(() => {
                if (!hasMoved) {
                    startTouchDrag(e, card);
                }
            }, 600);

            // Prevenir scroll mientras se eval√∫a el long press
            e.preventDefault();
        }, { passive: false });

        // Touch move - detectar movimiento
        card.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            const deltaX = Math.abs(touch.clientX - startPos.x);
            const deltaY = Math.abs(touch.clientY - startPos.y);

            // Si se mueve m√°s de 10px, cancelar long press
            if (deltaX > 10 || deltaY > 10) {
                hasMoved = true;
                clearTimeout(longPressTimer);
            }

            // Si ya est√° en modo drag, mover el elemento
            if (isDragging && draggedElement === card) {
                handleTouchMove(e);
                e.preventDefault();
            }
        }, { passive: false });

        // Touch end - finalizar drag
        card.addEventListener('touchend', (e) => {
            clearTimeout(longPressTimer);
            
            if (isDragging && draggedElement === card) {
                handleTouchEnd(e);
            }
        });
    }

    // ===== INICIAR DRAG T√ÅCTIL =====
    function startTouchDrag(e, card) {
        e.preventDefault();
        
        draggedElement = card;
        draggedId = card.dataset.id;
        isDragging = true;

        console.log('üîÑ Iniciando drag t√°ctil:', draggedId);

        // Vibraci√≥n de feedback (si est√° disponible)
        if (navigator.vibrate) {
            navigator.vibrate(100);
        }

        // Crear preview del elemento siendo arrastrado
        createDragPreview(card, e.touches[0]);

        // A√±adir clase visual
        card.classList.add('dragging', 'touch-dragging');

        // Hacer otros elementos semi-transparentes
        document.querySelectorAll('.plan-card:not(.dragging)').forEach(otherCard => {
            otherCard.style.opacity = '0.5';
        });

        // Calcular offset desde el punto de toque
        const rect = card.getBoundingClientRect();
        const touch = e.touches[0];
        touchOffset = {
            x: touch.clientX - rect.left,
            y: touch.clientY - rect.top
        };

        // Actualizar targets de drop
        updateDropTargets();
    }

    // ===== CREAR PREVIEW VISUAL =====
    function createDragPreview(card, touch) {
        dragPreview = card.cloneNode(true);
        dragPreview.classList.add('drag-preview');
        dragPreview.style.cssText = `
            position: fixed;
            top: ${touch.clientY - touchOffset.y}px;
            left: ${touch.clientX - touchOffset.x}px;
            width: ${card.offsetWidth}px;
            pointer-events: none;
            z-index: 10000;
            opacity: 0.9;
            transform: rotate(3deg) scale(1.05);
            transition: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 2px solid #3b82f6;
        `;
        
        document.body.appendChild(dragPreview);
    }

    // ===== MANEJAR MOVIMIENTO T√ÅCTIL =====
    function handleTouchMove(e) {
        if (!isDragging || !dragPreview) return;

        const touch = e.touches[0];
        
        // Mover el preview
        dragPreview.style.left = `${touch.clientX - touchOffset.x}px`;
        dragPreview.style.top = `${touch.clientY - touchOffset.y}px`;

        // Encontrar elemento bajo el dedo
        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        const dropTarget = elementBelow?.closest('.plan-card');

        // Limpiar highlights previos
        document.querySelectorAll('.plan-card').forEach(card => {
            card.classList.remove('drag-over', 'drop-target', 'drop-before', 'drop-after');
        });

        // Highlight del target actual
        if (dropTarget && dropTarget !== draggedElement) {
            dropTarget.classList.add('drag-over', 'drop-target');
            
            // Determinar si insertar antes o despu√©s
            const rect = dropTarget.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            
            if (touch.clientY < midY) {
                dropTarget.classList.add('drop-before');
            } else {
                dropTarget.classList.add('drop-after');
            }
        }
    }

    // ===== FINALIZAR DRAG T√ÅCTIL =====
    async function handleTouchEnd(e) {
        if (!isDragging) return;

        console.log('‚úã Finalizando drag t√°ctil');

        // Vibraci√≥n de finalizaci√≥n
        if (navigator.vibrate) {
            navigator.vibrate([50, 30, 50]);
        }

        try {
            // Encontrar el target de drop
            const changedTouch = e.changedTouches[0];
            const elementBelow = document.elementFromPoint(changedTouch.clientX, changedTouch.clientY);
            const dropTarget = elementBelow?.closest('.plan-card');

            if (dropTarget && dropTarget !== draggedElement) {
                console.log('üìç Drop t√°ctil en:', dropTarget.dataset.id);
                await performDrop(draggedElement, dropTarget, changedTouch);
            } else {
                console.log('‚ùå Drop t√°ctil cancelado - no hay target v√°lido');
                showToast('‚ö†Ô∏è Drag cancelado', 'info');
            }

        } catch (error) {
            console.error('‚ùå Error en drop t√°ctil:', error);
            showToast('‚ö†Ô∏è Error al reordenar', 'error');
        } finally {
            cleanupTouchDrag();
        }
    }

    // ===== REALIZAR DROP (COM√öN) =====
    async function performDrop(draggedEl, dropTarget, position) {
        try {
            const container = document.getElementById('planesList');
            const allCards = Array.from(container.querySelectorAll('.plan-card'));
            
            const draggedIndex = allCards.indexOf(draggedEl);
            const targetIndex = allCards.indexOf(dropTarget);
            
            console.log(`üîÑ Moviendo de posici√≥n ${draggedIndex} a ${targetIndex}`);
            
            if (draggedIndex === -1 || targetIndex === -1) {
                throw new Error('√çndices inv√°lidos para drag/drop');
            }
            
            // Determinar posici√≥n de inserci√≥n
            let insertBefore = null;
            
            if (position && position.clientY) {
                const rect = dropTarget.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                insertBefore = position.clientY < midY;
            } else {
                insertBefore = draggedIndex > targetIndex;
            }
            
            // Mover en el DOM
            if (insertBefore) {
                container.insertBefore(draggedEl, dropTarget);
            } else {
                container.insertBefore(draggedEl, dropTarget.nextSibling);
            }
            
            // Actualizar orden en servidor
            await updatePlanOrder();
            
            // Feedback visual de √©xito
            draggedEl.classList.add('drop-success');
            setTimeout(() => {
                if (draggedEl?.classList) {
                    draggedEl.classList.remove('drop-success');
                }
            }, 1000);
            
            showToast('‚úÖ Orden actualizado correctamente', 'success');
            
        } catch (error) {
            console.error('‚ùå Error realizando drop:', error);
            showToast('‚ö†Ô∏è Error al reordenar: ' + error.message, 'error');
            await loadPlanes(); // Recargar en caso de error
        }
    }

    // ===== LIMPIAR DRAG T√ÅCTIL =====
    function cleanupTouchDrag() {
        // Remover preview
        if (dragPreview) {
            dragPreview.remove();
            dragPreview = null;
        }

        // Limpiar clases y estilos
        document.querySelectorAll('.plan-card').forEach(card => {
            card.style.opacity = '1';
            card.classList.remove(
                'dragging', 'touch-dragging', 'drag-over', 
                'drop-target', 'drop-before', 'drop-after'
            );
        });

        // Reset variables
        isDragging = false;
        draggedElement = null;
        draggedId = null;
        touchOffset = { x: 0, y: 0 };
        dropTargets = [];
    }

    // ===== ACTUALIZAR TARGETS DE DROP =====
    function updateDropTargets() {
        dropTargets = Array.from(document.querySelectorAll('.plan-card'))
            .filter(card => card !== draggedElement);
    }

    // ===== EVENTOS DE MOUSE PARA ESCRITORIO =====
    function setupMouseEvents(card) {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('dragenter', handleDragEnter);
        card.addEventListener('dragleave', handleDragLeave);
        card.addEventListener('drop', handleDropMouse);
    }

    // ===== DRAG START PARA MOUSE =====
    function handleDragStart(e) {
        draggedElement = e.currentTarget;
        draggedId = e.currentTarget.dataset.id;
        
        e.currentTarget.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', e.currentTarget.outerHTML);
        
        console.log('üîÑ Arrastrando plan (mouse):', draggedId);
        
        setTimeout(() => {
            document.querySelectorAll('.plan-card:not(.dragging)').forEach(card => {
                card.style.opacity = '0.5';
            });
        }, 0);
    }

    // ===== DROP PARA MOUSE =====
    async function handleDropMouse(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const dropTarget = e.currentTarget;
        dropTarget.classList.remove('drag-over', 'drop-target');
        
        if (!draggedElement || dropTarget === draggedElement) {
            return false;
        }

        await performDrop(draggedElement, dropTarget, { clientY: e.clientY });
        return false;
    }

    // ===== DRAG END PARA MOUSE =====
    function handleDragEnd(e) {
        console.log('‚úã Fin del arrastre (mouse)');
        
        if (e.currentTarget?.classList) {
            e.currentTarget.classList.remove('dragging');
        }
        
        document.querySelectorAll('.plan-card').forEach(card => {
            if (card.style) card.style.opacity = '1';
            if (card.classList) {
                card.classList.remove('drag-over', 'drop-target');
            }
        });
        
        draggedElement = null;
        draggedId = null;
    }

    // ===== EVENTOS DE DRAG (SIN CAMBIOS) =====
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnter(e) {
        if (e.currentTarget !== draggedElement && e.currentTarget.classList) {
            e.currentTarget.classList.add('drag-over');
        }
    }

    function handleDragLeave(e) {
        if (e.currentTarget?.classList) {
            e.currentTarget.classList.remove('drag-over');
        }
    }

    // ===== ACTUALIZAR ORDEN EN SERVIDOR =====
    async function updatePlanOrder() {
        try {
            const container = document.getElementById('planesList');
            if (!container) {
                throw new Error('Container not found');
            }

            const cards = Array.from(container.querySelectorAll('.plan-card'));

            if (cards.length === 0) {
                console.warn('‚ö†Ô∏è No cards found for reordering');
                return;
            }

            // Crear array con el nuevo orden (order invertido para que el primero tenga el valor m√°s alto)
            const newOrder = cards.map((card, index) => {
                const id = card.dataset.id;
                if (!id) {
                    console.warn('‚ö†Ô∏è Card without ID found:', card);
                    return null;
                }
                return {
                    id: id,
                    order: cards.length - index // Invertir orden: primer elemento = valor m√°s alto
                };
            }).filter(item => item !== null); // Filtrar elementos nulos

            if (newOrder.length === 0) {
                throw new Error('No valid cards to reorder');
            }

            console.log('üì§ Enviando nuevo orden:', newOrder);

            const response = await fetch('/api/planes/reorder', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ order: newOrder })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const result = await response.json();
            console.log('‚úÖ Orden actualizado en servidor:', result);

        } catch (error) {
            console.error('‚ùå Error actualizando orden:', error);
            throw error;
        }
    }

    // ===== ELIMINAR PLAN =====
    async function deletePlan(planId) {
        if (!planId) {
            showToast('‚ö†Ô∏è ID de plan no v√°lido', 'error');
            return;
        }
        
        if (!confirm('¬øEst√°s seguro de que quieres eliminar este plan?')) {
            return;
        }

        try {
            console.log('üóëÔ∏è Eliminando plan:', planId);
            
            const response = await fetch(`/api/planes/${planId}`, { 
                method: 'DELETE' 
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            await loadPlanes();
            showToast('üóëÔ∏è Plan eliminado correctamente', 'success');
            
        } catch (error) {
            console.error('‚ùå Error eliminando plan:', error);
            showToast('‚ö†Ô∏è Error al eliminar: ' + error.message, 'error');
        }
    }

    // ===== MOVER PLAN AL TOP =====
    async function movePlanToTop(planId) {
        if (!planId) {
            showToast('‚ö†Ô∏è ID de plan no v√°lido', 'error');
            return;
        }
        
        try {
            console.log('‚¨ÜÔ∏è Moviendo plan al top:', planId);
            
            const response = await fetch(`/api/planes/${planId}/top`, { 
                method: 'PUT' 
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            await loadPlanes();
            showToast('‚¨ÜÔ∏è Plan movido al inicio', 'success');
            
        } catch (error) {
            console.error('‚ùå Error moviendo plan:', error);
            showToast('‚ö†Ô∏è Error al mover: ' + error.message, 'error');
        }
    }

    // ===== MANEJAR ENV√çO DE FORMULARIO =====
    async function handlePlanSubmit(e) {
        e.preventDefault();

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;

        // Obtener valores del formulario
        const titulo = document.getElementById('planTitulo').value.trim();
        const descripcion = document.getElementById('planDescripcion').value.trim();
        const prioridad = document.getElementById('planPrioridad').value;

        if (!titulo) {
            showToast('‚ö†Ô∏è El t√≠tulo es obligatorio', 'error');
            return;
        }

        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        submitBtn.disabled = true;

        try {
            console.log('üì§ Creando nuevo plan:', { titulo, descripcion, prioridad });
            
            const response = await fetch('/api/planes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    titulo: titulo,
                    descripcion: descripcion,
                    prioridad: parseInt(prioridad)
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            console.log('‚úÖ Plan creado:', result);

            closePlanModal();
            await loadPlanes();
            showToast('‚úÖ Plan a√±adido correctamente', 'success');
            
        } catch (error) {
            console.error('‚ùå Error creando plan:', error);
            showToast('‚ö†Ô∏è Error al guardar: ' + error.message, 'error');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    // ===== MODAL =====
    function openPlanModal() {
        document.getElementById('overlayPlan').style.display = 'flex';
        document.body.style.overflow = 'hidden';
        setTimeout(() => {
            document.getElementById('planTitulo').focus();
        }, 100);
    }

    function closePlanModal() {
        document.getElementById('overlayPlan').style.display = 'none';
        document.body.style.overflow = 'auto';
        document.getElementById('planForm').reset();
    }

    // ===== FUNCIONES AUXILIARES =====
    function getPriorityIcon(priority) {
        switch (parseInt(priority)) {
            case 1: return 'üî¥';
            case 2: return 'üü°';
            case 3: return 'üü¢';
            default: return '‚ö™';
        }
    }

    function getPriorityText(priority) {
        switch (parseInt(priority)) {
            case 1: return 'Alta';
            case 2: return 'Media';
            case 3: return 'Baja';
            default: return 'Sin prioridad';
        }
    }

    function formatDate(dateString) {
        if (!dateString) return 'Sin fecha';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch {
            return 'Fecha inv√°lida';
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ===== SISTEMA DE NOTIFICACIONES =====
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        if (!container) {
            console.error('Toast container not found');
            return;
        }

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.style.cssText = `
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
        `;
        
        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            </div>
        `;

        container.appendChild(toast);

        // Animaci√≥n de entrada
        setTimeout(() => {
            toast.style.transform = 'translateX(0)';
        }, 100);

        // Auto-remove despu√©s de 4 segundos
        setTimeout(() => {
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 300);
        }, 4000);
    }

    // ===== FUNCIONES GLOBALES =====
    window.deletePlan = deletePlan;
    window.movePlanToTop = movePlanToTop;
    window.loadPlanes = loadPlanes;