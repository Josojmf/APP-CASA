{% extends "layout.html" %}
{% block title %}Configuraci√≥n{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/configuracion.css') }}">
{% endblock %}

{% block content %}
<h1 class="title">‚öôÔ∏è Panel de Configuraci√≥n</h1>

<section class="theme-toggle">
    <h2>Cambiar tema</h2>
    <label class="switch">
        <input type="checkbox" id="themeSwitch">
        <span class="slider round"></span>
    </label>
</section>
<section class="task-management">
    <h2>Gesti√≥n de tareas</h2>
    <button id="clearTasksBtn">Eliminar todas las tareas</button>
    <script>
        document.getElementById("clearTasksBtn").addEventListener("click", async () => {
            if (confirm("¬øEst√°s seguro de que quieres eliminar todas las tareas?")) {
                const res = await fetch("/api/clear_all_tasks", { method: "POST" });
                if (res.ok) {
                    alert("‚úÖ Todas las tareas han sido eliminadas");
                    location.reload();
                } else {
                    alert("‚ö†Ô∏è Error al eliminar las tareas");
                }
            }
        });
    </script>
</section>
<section class="user-management">
    <h2>Usuarios</h2>
    <form id="addUserForm">
        <input type="text" id="nuevoUsuario" placeholder="Nombre del nuevo usuario" required>
        <input type="file" id="imagenUsuario" accept="image/png, image/jpeg" required>
        <button type="submit">A√±adir</button>
    </form>

    <ul class="user-list">
        {% for user in users %}
        <li>
            <span class="user-info">
                üë§ {{ user.nombre }} {% if user.encasa %}üü¢ En casa{% else %}üî¥ Fuera{% endif %}
            </span>
            <button class="delete-btn" onclick="eliminarUsuario('{{ user._id }}')">Eliminar</button>
        </li>
        {% endfor %}
    </ul>
</section>
{% endblock %}

{% block extra_js %}
<script>
    function eliminarUsuario(userId) {
        if (confirm("¬øEst√°s seguro de que quieres eliminar este usuario?")) {
            fetch(`/api/delete_user/${userId}`, { method: "DELETE" })
                .then(res => {
                    if (res.ok) location.reload();
                    else alert("‚ö†Ô∏è Error al eliminar usuario");
                });
        }
    }

    document.getElementById("addUserForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const nombre = document.getElementById("nuevoUsuario").value.trim();
        const imagenInput = document.getElementById("imagenUsuario");
        const archivo = imagenInput.files[0];

        if (!nombre || !archivo) {
            alert("Debes rellenar el nombre y subir una imagen.");
            return;
        }

        if (!["image/jpeg", "image/png"].includes(archivo.type)) {
            alert("Solo se permiten im√°genes JPG o PNG.");
            return;
        }

        const reader = new FileReader();
        reader.onload = async function () {
            const base64Img = reader.result;

            const res = await fetch("/api/add_user", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nombre, imagen: base64Img })
            });

            if (res.ok) location.reload();
            else alert("‚ö†Ô∏è Error al a√±adir usuario");
        };
        reader.readAsDataURL(archivo);
    });

    document.addEventListener("DOMContentLoaded", () => {
        const switchElement = document.getElementById("themeSwitch");
        const currentTheme = document.body.classList.contains("dark") ? "dark" : "light";
        switchElement.checked = currentTheme === "dark";

        switchElement.addEventListener("change", async () => {
            const newTheme = switchElement.checked ? "dark" : "light";

            const res = await fetch("/api/toggle_theme", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ theme: newTheme })
            });

            if (res.ok) {
                // Opci√≥n 1: cambiar la clase directamente (cambio visual inmediato sin recarga)
                document.body.classList.remove("light", "dark");
                document.body.classList.add(newTheme);

                // Opci√≥n 2 (RECOMENDADA): forzar recarga para aplicar desde backend/session
                location.reload();
            }
        });
    });
</script>

{% endblock %}